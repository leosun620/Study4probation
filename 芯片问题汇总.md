[TOC]

芯片总结

1. 在流水线上传输的是整个packet还是头128 B？

   答：在流水线上的数据，其实通过packet parse engine提取报文中的头128字节来得到这个报文的描述符，这个描述符包括了EtherType，DIP，SIP，DMAC，SMAC....这些字段其实是报文的行为与特征的描述。而在流水线中我们传递的是这个描述结构体，而不是完整的报文信息。如果是整个报文信息进行流水线的操作，将会占用很大的应用消耗，同时后面的引擎并没有对这些数据流进行操作，所以在处理的时候我们只要将收到的报文缓存起来，提取其重要的描述符信息参与流水线的数据处理。

2. 各个引擎是不是都必须进行？

   答：各个引擎是相互独立的，并且都有开关进行控制，如果我们不需要进行三层路由，我们就可以将L3路由引擎关闭。

3. CPU中会产生Ethernet packet和HiGig报文，这是怎么产生的？

   答：首先我们可以通过CLI，Ping某个IP，这个就会通过协议栈产生报文，这个产生就是通过CPU实现的。这里我们可以把CPU看做一个输入端进入Packet Parsing。

4. 在L2，L3处理的时候，都会产生Copy to CPU 的操作？

   答：这里Copy to CPU，并不会影响接下来的流水线。只是把报文从buffer managerment送到CPU去。描述符（struct）仍然继续往流水线下走。

5. DIP查找的时候，是怎么样得到下一跳的DMAC，这个DMAC不可能是通过查表得到的。首先如果有10000个路由的下一跳是这个DMAC，那么就会有10000的表项，这是明显不能够实现的。那是怎么实现的。我们在进行三层表项查找的时候会得到索引得到ING\_L3\_NEXT\_HOP 和 EGR\_L3\_NEXT\_HOP，ING\_L3\_NEXT\_HOP获得DST_MODID（这个0表示是本端口）和DST\_PORT（这个就是出端口），从 EGR\_L3\_NEXT\_HOP得到下一跳MAC地址和索引指向EGR\_L3\_INTF,可以得到出口MAC和VID。

6. 送CPU处理即是指软件处理。

   ​

   ​

7. 我们在L3处理的时候，如果查不到表项，我们的一般操作是什么？为什么？

   答：我们查不到的时候，往往是不做处理，如果是送CPU的话，如果一万条路由都查不到，送到CPU，就会造成CPU性能耗光。

8. L2层的数据模型是什么？

   答：通过查找L2表和Port表（CML bit）来决定转发逻辑。

9. L3层的数据模型是什么？

   答：前缀和下一跳。

10. ARP报文是否会进入三层逻辑？所有的ARP报文在我们公司都会往CPU送？

  答：虽然L3置位，但是由于ARP的DMAC是广播，所以不会进入三层转发。

11. 我们在L2 中进行DMAC查找的时候，如果能够进行特定转发，那么我们必然会得到一个DST_MODID,DST_PORT,这个两个字段，这两个转发来决定从哪个出口转发出去，转发到哪一个芯片。如果DST_MODID =0,表示从该芯片的摸个端口转发出去。

12. CPU通过PCI和CMIC进行通信，这里面的通信内容可以是哪一些？

    答：1.通过CLI的一些配置信息通过这里来对寄存器进行设置。2.相关报文：Ethernet报文和HiGig报文。这些报文是进过协议栈生成的。

13. L3 table 和L3\_DEF_IP table有什么区别，表项内容有什么不同，所以才会导致，先查和后查。

14. 二层表项我们大部分都是可以学习的例如L2 table，而三层表项L3则是通过CLI下发设置通过CPU进行设置的。 


# intelligent parser 

1. 全解析针对什么port？

   答：全解析针对以太网端口和CMIC端口（面板口与CPU口）。

2. HiGig 解析针对的什么port，其中有哪些关键字段，与全解析有什么区别？

   答：HiGig解析针对HiGig端口，就有一些控制信息，来实现芯片端口的镜像、聚合、QoS。关键字段有DST_MODID、SRC_MODID、HDR_EXT_LENGTH、VID_HIGH、VID_LOW、VID_LOW、 SRC_MODID、SRC_PORT_TGID、DST_PORT、DST_MODID 等。

3. 在这个模块中报文在生成描述符的时候，其中还有包括一些状态字段，这些字段是供给后面模块使用的，来标识后面模块流水线的状态。因此在初始化这些字段的时候，其字段的内容先是为空，表示未赋值。我只讲了一些报文的相关字段：DMAC,SMAC,DIP,SIP,EtherType.这些是不够的。

# security engine 

不做重点理解

# L2 switch 

1. L2 switch 中的VLAN 分配是什么，端口这么对这些vlan id 处理？

   答：如果是 untag 报文，vlan模块将进行基于MAC的、基于子网的、基于协议的和基于端口的vlan分配。

2. 这里的优先级指的是什么？

   答：在分配vlan的时候，我们可以对报文添加优先级cos,这样报文可以决定是在出端口对应的8个cos队列中的哪一个，通过这个方式可以决定报文转发的优先级。

3. SMAC 是如何学习的？

   答：将（SMAC + VLANID）作为hash的索引在L2 Table（MAC表）查找，如果不存在则根据CML位来决定芯片的自动学习，转发，丢弃，或者送CPU。如果存在，则更新hit值；如果端口发生了变化，那么则对端口同样依据CML进行处理。

4. 查找DMAC的流程是什么？

   答：单播情况：首先在L2表项中查找DMAC，如果没有查找到，那么就在对应的VLAN进行泛洪；如果查找到了，再看L3是否置位，如果置位，那么就进行三层转发，反之，就将报文转发到对应的出端口。

   ​

5. AP 是什么？

   可以把多个物理链接捆绑在一起形成一个逻辑链接，这个逻辑链接我们称之为Aggregate Port（以下简称AP）。它可以用于扩展链路带宽，提供更高的连接可靠性。

   ​

6. STP是什么，怎么工作？

7. 基于子网，基于MAC，基于协议，基于端口的VLAN分配是通过什么bit来实现的？


# L3 Switch

1. 如何进入这个引擎？ 

   答：首先要将这个L3路由引擎打开；其次当我们在L2进行DMAC查找的时候，发现L3 bit置位，那么就进入L3转发流程：

   + 然后在L3_Table中对SIP进行查找，如果没有查到，送CPU处理，如果查到则更新命中位L3\_hit\_bit，同时检查端口是否发生了位移，如果发生位移同样发送到CPU处理，同时更新接口表；
   + 进行DIP的查找，如果在主机路由表中没有查到，同时到子网路由表中查找，那么就会在子网路由表中进行最长子网匹配算法（LMP），如果还没有找到，就会将送CPU进行处理，如果在主机路由表或者子网路由表中找到了，将会得到下一跳的指针。包括了下一跳MAC地址，还有接口表的索引。在包转发出去的时候，将会用下一跳MAC地址替换DMAC，同时接口表中的MAC，vlan字段分别替换描述符中的SMAC，vlan。

# ContentAware Processor

1. FP能做什么？

   ​

2. FP中关键字的选取？

   已经由硬件固定形成不同的组合，只能从这些组合中选择，或者可以通过自定义域来实现自己定义

   （UDF_OFFSET table).

3. FP有哪些动作?

   丢弃，替换，重定向，复制到CPU处理。

4. FP内部是如何实现的？

   CAP也即是FP。它包括了五个部分：Intelligent protocol-aware selector，ContentAware lookup engine，ContentAware policy engine，ContentAware metering and statistic engine，ContentAware action resolution engine。

5. Hash 和TCAM的优缺点和不同点在哪里，应用场景又是如何分别应用在什么表项？

   + Hash：它是由Key-value的形式进行查找
   + TCAM：叫三态查找，拥有0,1，不关心这3个状态。它需要一个掩码，1表示关心各个状态，0表示忽略的这个状态。它的实现的功能是依据内容查找地址。由于它的硬件实现复杂要求高，因此价格也很高。

6. 在FP中CAM是如何进行查找的？

   首先FP（56500）中有16个CAM查找引擎。在入端口的时候，智能协议选择引擎对包中前128字节安装协议字段进行选择和标记，CAM查找引擎按照用户给的key匹配协议选择器中的内容，这16个CAM是并行进行查找，产生16个结果，如果不冲突则全部执行，如果冲突了则选择优先级高的行为执行（地址越低优先级越高）。

7. Hash查找又是怎么进行查找的？

   ​

8. Hash中key产生冲突了是如何解决。

   ​

9. TCAM作为LMP查找，应该如何设计？

   答：按掩码长度降序处理。

10. Hash表一般是存放什么数据，数量大的话就适合存放Hash吗？

  ​

11. 精确的用什么查找，模糊的用什么查找？

    答：精确查找用Hash，模糊查找用TCAM

12. Hash表为什么有hit位，TCAM需不需要？

    答：Hash表应用于L2,L3查找，在这个过程中，按照逻辑要求，表项内容条目会发生学习更新，老化等情况，所以都会有一个hit位。而TCAM表示自己设置的，并不需要通过设置hit位来实现老化与学习。


# Buffer Management

1. buffer managemet主要的作用是什么？
   + 首先任何报文在芯片处理之前，都需要将自己的内容缓存在buffer management这里，buffer management 通过控制每个端口的数据流量情况，避免出现过度竞争，导致有的端口不能够得到调度进行数据的传送，饿死了。在宏观上使得每个端口都能够更加合理的利用这个流水线和buffer。

# Traffic Management

1. Queue与CoS之间的关系？

   答：每个出端口都拥有8个queue，这8个queue之间存在不同的CoS的优先级，优先级高的队列可以先发送。

2. Traffic Management的作用是什么，有什么功能？

   + Queue 每个出端口拥有8个CoS队列，
   + Scheduling 调度器可以配置不同的模式对这8个队列进行不同的仲裁。通过提供最小带宽保证与最大带宽限制，通过监视每个CoS队列的计数机制实现。
   + Shaped 流量整形的目的是针对入口突然流量的处理，使得流量变得稍微平滑点。

3. 硬件时钟是什么？

   指的是硬件读取比特流的速度，因此在数据传输之前，硬件之间将会进行自协商，以相互都都能够接受的速率进行传输。


# Modification

1. Modification 具体指modify 哪些内容，依据什么modify，为什么要modify，意义何在？

   ​

   ​

2. 该引擎能否改变出端口，为什么，该功能在哪一步已经结束了？

   Modification并不能修改报文的出端口，在Buffer Manager engine已经到达出口了，所以无法再修改出端口。

3. Modification的作用是什么？

   答：针对之前流水线的作用，会更改描述符中的相关字段的内容，在完全转发出去之前，必须要将更改后的描述符填充到从buffer 中拿到的packet当中，这样修改后的报文才能够转发出去。








​











